<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>æ‰“å¡ç³»çµ±</title>

  <!-- PWA -->
  <link rel="manifest" href="/public/manifest.json">
  <meta name="theme-color" content="#16a34a">
  <link rel="icon" href="/public/icon-192.png" sizes="192x192">
  <link rel="apple-touch-icon" href="/public/icon-192.png">

  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <header class="topbar">
    <h1>æ‰“å¡ç³»çµ± <small id="verBadge"></small></h1>
  </header>

  <main id="app">
    <!-- â¶ æŠŠä½ ç›®å‰ã€Œæ‰“å¡é  index çš„æ•´å€‹ä¸»è¦ HTMLï¼ˆä¸å« <html> <head> ï¼‰ã€è²¼é€²ä¾† -->
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>æ‰“å¡ç³»çµ±</title>

<style>
  :root{
    --primary:#16a34a; --secondary:#3b82f6; --leave:#9333ea; --trip:#06b6d4; --corr:#f59e0b;
    --border:#2f3a49; --muted:#6b7280; --chip:#e5e7eb; --card:#ffffff; --bg:#f6f8fb; --maxw:1200px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);font: clamp(16px,2.4vw,18.5px)/1.65 system-ui,-apple-system,"Noto Sans TC",Segoe UI,Roboto,Arial}
  .wrap{max-width:min(var(--maxw),100vw);margin:0 auto;min-height:100dvh;padding: clamp(10px, 2.4vw, 20px)}
  h1{margin:6px 0 14px;font-size:clamp(18px,2.6vw,22px)}
  .grid{display:grid;gap:14px} .row{display:flex;gap:14px;flex-wrap:wrap} .row-lg{gap:16px}
  input,button,select,textarea{font:inherit}
  input[type="text"],input[type="password"],select,textarea{flex:1 1 220px;height: clamp(48px,6.5vh,56px);padding:12px 14px;border:2px solid var(--border);border-radius:14px;background:#fff}
  .btn{height: clamp(48px,6.7vh,58px);padding:0 clamp(12px,2vw,18px);border:2px solid var(--border);border-radius:16px;cursor:pointer;background:#fff;font-weight:700;letter-spacing:.02em}
  .btn-primary{background:var(--primary);border-color:var(--primary);color:#fff}
  .btn-secondary{background:var(--secondary);border-color:var(--secondary);color:#fff}
  .btn-leave{background:var(--leave);border-color:var(--leave);color:#fff}
  .btn-trip{background:var(--trip);border-color:var(--trip);color:#fff}
  .btn-corr{background:var(--corr);border-color:var(--corr);color:#fff}
  .btn-ghost{background:#fff}
  .card{background:var(--card);border:2px solid var(--border);border-radius:18px;padding: clamp(12px,1.8vw,18px);height:100%}
  .title{display:flex;align-items:center;justify-content:space-between;margin:6px 0 10px}
  .muted{color:var(--muted)} .badge{display:inline-block;padding:4px 12px;border-radius:999px;background:var(--chip);font-size:.92em}
  .clock{border:2px solid var(--border);border-radius:14px;padding:10px 14px;background:#fff;font-weight:700}
  .main-grid{display:grid;grid-template-columns:1.25fr 0.9fr;gap: clamp(10px,1.8vw,16px);grid-auto-rows:minmax(220px,1fr);align-items:stretch}
  .h-100{height:100%}
  #todayList .recentItem{display:grid;grid-template-columns:auto auto 1fr auto;gap:10px;align-items:center;min-height: clamp(42px,6vh,52px);font-size:.95em}
  .type-pill{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:999px;font-size:.92em;font-weight:700;line-height:1;background:#e5e7eb;color:#111827}
  .type-pill.in{background:#dcfce7;color:#166534} .type-pill.out{background:#dbeafe;color:#1d4ed8}
  @media (max-width:960px){ .main-grid{ grid-template-columns:1fr; grid-auto-rows:minmax(220px,auto) } }
  #tools{ display:grid; gap:14px; align-content:start }
  #btn-in,#btn-out{height:14vh !important;font-size:min(7vw,5.2vh) !important;font-weight:900;line-height:1.06 !important;border-width:3px;border-radius:20px;display:flex;align-items:center;justify-content:center;padding:0}
  #tools .btn{height:12vh !important;font-size:min(6.5vw,4.2vh) !important;font-weight:900;line-height:1.06 !important;border-width:3px;border-radius:18px;display:flex;align-items:center;justify-content:center;padding:0}
  #freeze-mask{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(255,255,255,.75);backdrop-filter:saturate(.6) blur(2px);z-index:9999}
  #freeze-mask .box{background:#fff;border:2px solid var(--border);border-radius:16px;padding:16px 18px;font-weight:900;font-size:18px;box-shadow:0 10px 30px rgba(0,0,0,.2)}
  body.is-freeze{overflow:hidden}
  #btn-loc,#locChip{display:none !important}
  #btn-in,#btn-out,#tools .btn{white-space:nowrap;word-break:keep-all;overflow:hidden;text-overflow:clip;letter-spacing:0;padding-left:.1em;padding-right:.1em}
.version-badge{
  font-size:0.8em;
  margin-left:10px;
  padding:2px 8px;
  border-radius:8px;
  background:var(--chip);
  color:var(--muted);
}


</style>
</head>
<body>
<div class="wrap">
<h1>
  æ‰“å¡ç³»çµ±
  <span id="appVersion" class="version-badge"></span>
</h1>


  <div class="card grid">
    <div class="row">
      <input id="uid" type="text" placeholder="UID">
      <input id="pass" type="password" placeholder="PASSCODE">
    </div>
    <div class="row">
      <button id="btn-loc" class="btn btn-ghost">ğŸš© å–å¾—å®šä½</button>
      <div id="locChip" class="loc-line muted" style="flex:1">â„¹ï¸ æ‰“å¡æ™‚æœƒè‡ªå‹•å–å¾—ç•¶ä¸‹å®šä½</div>
    </div>
  </div>

  <div class="main-grid" style="margin-top:12px;">
    <div class="grid h-100">
      <div id="clock" class="clock">ğŸ•“ ç¾åœ¨æ™‚é–“ï¼š--</div>

      <div class="row row-lg">
        <button id="btn-in"  class="btn btn-primary"  style="flex:1">ä¸Šç­æ‰“å¡</button>
        <button id="btn-out" class="btn btn-secondary" style="flex:1">ä¸‹ç­æ‰“å¡</button>
      </div>

      <div id="resp" class="card muted">å°šæœªæ‰“å¡</div>

      <div class="card h-100">
        <div class="title"><strong>ä»Šæ—¥æ‘˜è¦</strong><span id="sumBadge" class="badge" style="display:none">ä»Šæ—¥æœ‰ç•°å¸¸</span></div>
        <div id="sumIn"  class="row" style="margin-bottom:8px"><span class="type-pill in">ä¸Šç­</span>&nbsp;<span class="muted">â€”</span></div>
        <div id="sumOut" class="row"><span class="type-pill out">ä¸‹ç­</span>&nbsp;<span class="muted">â€”</span></div>
        <div id="sumAno" class="muted" style="margin-top:8px"></div>
      </div>

      <div class="card h-100">
        <div class="title"><strong>ä»Šæ—¥æ˜ç´°</strong><div class="muted">åªé¡¯ç¤ºæœ€è¿‘ <span id="limitLabel">3</span> ç­†</div></div>
        <div id="todayList" class="grid" style="gap:10px"></div>
        <div style="margin-top:10px;text-align:center;"><button id="btnMore" class="btn btn-ghost" style="padding:8px 12px;border-radius:10px;">é¡¯ç¤ºæ›´å¤š</button></div>
      </div>
    </div>

    <div id="tools" class="card h-100" style="display:grid;gap:12px;align-content:start">
      <div class="title"><strong>å·¥å…·</strong></div>
      <button id="btn-leave"      class="btn btn-leave">ğŸ’Šè«‹å‡ç”³è«‹</button>
      <button id="btn-open-trip"  class="btn btn-trip">âœˆ å‡ºå·®ç”³è«‹</button>
      <button id="btn-open-corr"  class="btn btn-corr">ğŸ“„ è£œå¡ç”³è«‹</button>
      <button id="btn-open-calendar" class="btn btn-ghost btn-xl">ğŸ“… æŸ¥çœ‹æœˆæ›†</button>
      <button id="btn-help"       class="btn btn-ghost">â“ ä½¿ç”¨èªªæ˜</button>
    </div>
  </div>
</div>

<!-- Modal -->
<div id="req-modal" style="display:none">
  <div id="req-mask" style="position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:100"></div>
  <div id="req-card" style="position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:min(720px,92vw);max-height:88vh;overflow:auto;background:#fff;border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.2);z-index:101">
    <div class="hd" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <h3 id="req-title" style="margin:0;font-size:18px">â€”</h3>
      <button id="req-close" class="btn">é—œé–‰</button>
    </div>
    <div id="req-body"></div>
  </div>
</div>

<!-- Freeze -->
<div id="freeze-mask"><div class="box">è™•ç†ä¸­â€¦</div></div>

<!-- Templates -->
<template id="tpl-trip">
  <div class="form" style="display:grid;gap:12px">
    <div class="row" style="gap:10px">
      <input id="trip-uid"  type="text" placeholder="UIDï¼ˆè‡ªå‹•å¸¶å…¥ï¼‰">
      <input id="trip-pass" type="password" placeholder="PASSCODEï¼ˆè‡ªå‹•å¸¶å…¥ï¼‰">
    </div>
    <label>æ—¥æœŸ <input id="trip-date" type="date"></label>
    <label>åœ°é»/èªªæ˜ <input id="trip-location" type="text" placeholder="ä¾‹å¦‚ï¼šå°ä¸­â—â—å®¢æˆ¶"></label>
    <label>å‚™è¨» <input id="trip-note" type="text" placeholder="ï¼ˆå¯ç•™ç©ºï¼‰"></label>
    <div style="text-align:right;margin-top:8px;"><button id="btn-trip-submit" class="btn btn-trip">é€å‡ºå‡ºå·®ç”³è«‹</button></div>
  </div>
</template>

<template id="tpl-corr">
  <div class="form" style="display:grid;gap:12px">
    <div class="row" style="gap:10px">
      <input id="corr-uid"  type="text" placeholder="UIDï¼ˆè‡ªå‹•å¸¶å…¥ï¼‰">
      <input id="corr-pass" type="password" placeholder="PASSCODEï¼ˆè‡ªå‹•å¸¶å…¥ï¼‰">
    </div>
    <div class="row" style="gap:10px">
      <label style="flex:1">æ—¥æœŸ <input id="corr-date" type="date"></label>
      <label style="flex:1">æ™‚é–“ <input id="corr-time" type="time"></label>
    </div>
    <label>é¡å‹
      <select id="corr-type"><option value="in">ä¸Šç­</option><option value="out">ä¸‹ç­</option></select>
    </label>
    <label>å‚™è¨» <input id="corr-note" type="text" placeholder="ï¼ˆå¯ç•™ç©ºï¼‰"></label>
    <div style="text-align:right;margin-top:8px;"><button id="btn-corr-submit" class="btn btn-corr">é€å‡ºè£œå¡ç”³è«‹</button></div>
  </div>
</template>

<template id="tpl-leave">
  <div class="form" style="display:grid;gap:12px">
    <div class="row" style="gap:10px">
      <input id="lv-uid"  type="text" placeholder="UIDï¼ˆè‡ªå‹•å¸¶å…¥ï¼‰">
      <input id="lv-pass" type="password" placeholder="PASSCODEï¼ˆè‡ªå‹•å¸¶å…¥ï¼‰">
    </div>
    <label>è«‹å‡é¡åˆ¥
      <select id="lv-type">
        <option>ç‰¹ä¼‘</option><option>äº‹å‡</option><option>ç—…å‡</option>
        <option>å…¬å‡</option><option>å–ªå‡</option><option>å©šå‡</option>
        <option>ç”¢å‡</option><option>é™ªç”¢å‡</option><option>è£œä¼‘</option>
        <option>å…¶ä»–</option>
      </select>
    </label>
    <div class="row" style="gap:12px;align-items:center">
      <label style="display:flex;gap:8px;align-items:center;"><input id="lv-fullday" type="checkbox"> æ•´å¤©</label>
      <label style="display:flex;gap:8px;align-items:center;">æ™‚æ•¸ï¼ˆ0.5 å°æ™‚ç‚ºå–®ä½ï¼‰
        <input id="lv-hours" type="number" min="0.5" step="0.5" placeholder="ä¾‹å¦‚ 4" style="width:120px">
      </label>
    </div>
    <div class="row" style="gap:10px">
      <label style="flex:1">é–‹å§‹è«‹å‡æ—¥ <input id="lv-start" type="date"></label>
      <label style="flex:1">è«‹å‡çµæŸæ—¥ <input id="lv-end"   type="date"></label>
    </div>
    <label>äº‹ç”±/å‚™è¨» <textarea id="lv-note" placeholder="é¸å¡«" rows="3" style="resize:vertical"></textarea></label>
    <div style="text-align:right;margin-top:8px;"><button id="btn-leave-submit" class="btn btn-leave">é€å‡ºç”³è«‹</button></div>
  </div>
</template>

<template id="tpl-help">
  <div style="line-height:1.7">
    <h4 style="margin:0 0 8px">å¿«é€Ÿä¸Šæ‰‹</h4>
    <ol style="margin:0 0 14px;padding-left:22px;display:grid;gap:10px;">
      <li>å‘ç®¡ç†è€…å–å¾— <b>UID</b> èˆ‡ <b>PASSCODE</b>ï¼Œå¿…é ˆè¼¸å…¥æ­£ç¢ºæ‰å¯æ‰“å¡ã€‚</li>
      <li>æ‰“å¡æ™‚ç³»çµ±æœƒè‡ªå‹•å–å¾—å®šä½ï¼Œè«‹ç¢ºä¿ç€è¦½å™¨ï¼æ‰‹æ©Ÿå·²å…è¨±ã€Œå®šä½æ¬Šé™ã€ã€‚</li>
      <li>æŒ‰ä¸‹ã€Œä¸Šç­æ‰“å¡ / ä¸‹ç­æ‰“å¡ã€å¾Œï¼Œç­‰å¾…å®šä½æˆåŠŸèˆ‡ä¼ºæœå™¨å›æ‡‰ï¼Œéç¨‹ä¸­é é¢æœƒæš«æ™‚é–å®šã€‚</li>
      <li>è‹¥å‡ºç¾ã€Œç«™å¤–ã€ç•°å¸¸ï¼Œä»£è¡¨å®šä½é»èˆ‡å…¬å¸è·é›¢éé ï¼Œéœ€è£œå¡æˆ–èªªæ˜ã€‚</li>
      <li>å¦‚éœ€ <b>å‡ºå·® / è£œå¡ / è«‹å‡</b>ï¼Œå¯ä½¿ç”¨å³å´çš„å·¥å…·æŒ‰éˆ•é–‹å•Ÿè¡¨å–®ï¼Œé€å‡ºå¾Œæœƒé€²å…¥ã€Œå¾…å¯©æ ¸ã€ã€‚</li>
    </ol>

    <h4 style="margin:10px 0 8px">æ³¨æ„äº‹é …</h4>
    <ul style="margin:0 0 14px;padding-left:22px;display:grid;gap:8px;list-style:disc;">
      <li>æœ¬ç³»çµ±éœ€åœ¨ <b>https://</b> å®‰å…¨é€£ç·šä¸‹ä½¿ç”¨ï¼Œå¦å‰‡ç€è¦½å™¨æœƒå°é–å®šä½ã€‚</li>
      <li>è‹¥ä½¿ç”¨æ‰‹æ©Ÿï¼Œè«‹ç¢ºå®šå·²é–‹å•Ÿ GPS ä¸¦å…è¨±ã€Œæ­¤ç¶²ç«™ã€ä½¿ç”¨å®šä½ã€‚</li>
      <li>æ‰“å¡éç¨‹ä¸­å¦‚ 30 ç§’å…§ç„¡å›æ‡‰ï¼Œç³»çµ±æœƒè‡ªå‹•è§£é™¤é–å®šï¼Œè«‹é‡æ–°æ“ä½œã€‚</li>
      <li>è«‹å‡ã€å‡ºå·®ã€è£œå¡ç”³è«‹ä¸€å¾‹æœƒå…ˆæ¨™è¨˜ç‚º <b>pending</b>ï¼Œéœ€ç®¡ç†å“¡å¯©æ ¸é€šéæ‰æœƒåæ˜ åˆ°æœˆæ›†ã€‚</li>
      <li>å»ºè­°ç¬¬ä¸€æ¬¡ä½¿ç”¨æ™‚ï¼Œå…ˆå˜—è©¦æ‰“ä¸€æ¬¡æ¸¬è©¦å¡ï¼Œç¢ºèªå®šä½èˆ‡æ¬Šé™è¨­å®šæ­£å¸¸ã€‚</li>
    </ul>

    <h4 style="margin:10px 0 8px">å¸¸è¦‹å•é¡Œ</h4>
    <ul style="margin:0;padding-left:22px;display:grid;gap:8px;list-style:disc;">
      <li>å®šä½ä¸æˆåŠŸï¼šè«‹ç¢ºèªç¶²è·¯æš¢é€šã€ç€è¦½å™¨å…è¨±å®šä½ï¼Œå¿…è¦æ™‚æ”¹ç”¨æ‰‹æ©Ÿæ“ä½œã€‚</li>
      <li>é é¢å¡ä½ï¼šç­‰å¾… 30 ç§’å¾Œç³»çµ±æœƒè§£é™¤é–å®šï¼Œæˆ–æ‰‹å‹•é‡æ–°æ•´ç†å†å˜—è©¦ã€‚</li>
      <li>ç”³è«‹é€å‡ºå¾Œæ²’é¡¯ç¤ºï¼šè«‹ç¢ºèª UID èˆ‡ PASSCODE è¼¸å…¥æ­£ç¢ºï¼Œä¸¦é‡æ–°æ•´ç†æª¢æŸ¥ã€‚</li>
    </ul>
  </div>
</template>


<script>
(function(){
  // ===== åŸºæœ¬é¸å–å™¨ =====
  function $(s,el){ return (el||document).querySelector(s); }
  function $$(s,el){ return Array.from((el||document).querySelectorAll(s)); }

  // ===== æ™‚é˜ =====
  function tick(){
    var el = $('#clock'); if(!el) return;
    var d = new Date(), p = function(n){ return String(n).padStart(2,'0'); };
    el.textContent = 'ğŸ•“ ç¾åœ¨æ™‚é–“ï¼š' + d.getFullYear() + '/' + p(d.getMonth()+1) + '/' + p(d.getDate()) + ' ' + p(d.getHours()) + ':' + p(d.getMinutes()) + ':' + p(d.getSeconds());
  }
  setInterval(tick, 1000); tick();

  // ===== å‡çµé®ç½©ï¼ˆä¿åº• 12 ç§’ï¼‰ =====
  var __freezeTimer = null, __punching = false;
  var FREEZE_MAX_WAIT_MS = 20000;
 function setFreeze(on, msg){
  const mask = document.getElementById('freeze-mask');
  if (msg) mask.querySelector('.box').textContent = msg;
  mask.style.display = on ? 'flex' : 'none';
  document.body.classList.toggle('is-freeze', on);

  // åªé–ä¸Š/ä¸‹ç­å…©é¡†ï¼Œå…¶ä»–æŒ‰éˆ•ä¸å‹•
  ['btn-in','btn-out'].forEach(id=>{
    const el = document.getElementById(id);
    if (el) el.disabled = on;
  });
}


  // ===== å·¥å…· =====
  var esc=function(s){ return String(s||'').replace(/[&<>"]/g,function(c){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]); }); };
  function hmFromStr(str){ var m=String(str||'').match(/(\d{2}):(\d{2})/); return m?m[0]:'â€”'; }
  // è®“ç€è¦½å™¨ã€Œå…ˆæŠŠç•«é¢æ›´æ–°ä¸€æ¬¡ã€å†ç¹¼çºŒï¼ˆç¢ºä¿å‡çµé®ç½©å…ˆè¢«ç•«å‡ºä¾†ï¼‰
function nextPaint(){
  return new Promise(resolve=>{
    requestAnimationFrame(()=>setTimeout(resolve,0));
  });
}

  // ===== æ‘˜è¦/æ¸…å–® =====
  var SHOW_ALL=false, ALL_LIST=[];
  function renderSummary(sum){
    var i=$('#sumIn'), o=$('#sumOut'), a=$('#sumAno'), b=$('#sumBadge');
    var inStr  = sum && (sum.in || sum.in_time || '');
    var outStr = sum && (sum.out || sum.out_time || '');
    var anomalies = sum && (sum.anomalies || []);
    if(i) i.innerHTML='<span class="type-pill in">ä¸Šç­</span>&nbsp;<span class="muted">'+(inStr?hmFromStr(inStr):'â€”')+'</span>';
    if(o) o.innerHTML='<span class="type-pill out">ä¸‹ç­</span>&nbsp;<span class="muted">'+(outStr?hmFromStr(outStr):'â€”')+'</span>';
    if(a) a.textContent=(anomalies && anomalies.length) ? ('ç•°å¸¸ï¼š'+anomalies.join('ã€')) : '';
    if(b) b.style.display = (anomalies && anomalies.length) ? '' : 'none';
  }
  function renderTodayList(list){
    var box=$('#todayList'); if(!box) return; box.innerHTML='';
    (list||[]).forEach(function(it){
      var row=document.createElement('div'); row.className='recentItem';
      var dt=String(it.datetime||''); var hm=hmFromStr(dt);
      var isIn=/in/i.test(it.type||'');
      row.innerHTML= '<div class="badge">'+esc(hm||'--:--')+'</div>'
        + '<div class="type-pill '+(isIn?'in':'out')+'">'+(isIn?'ä¸Šç­':'ä¸‹ç­')+'</div>'
        + '<div class="muted">'+esc(it.site_id||'')+'</div>'
        + '<div class="muted">'+(typeof it.distance_m==='number' ? (it.distance_m+'m') : '')+'</div>';
      box.appendChild(row);
    });
  }
  function refreshSummaryAndList(){
    var uid=$('#uid') ? $('#uid').value.trim() : '', pass=$('#pass') ? $('#pass').value.trim() : '';
    if(!uid || !pass){ renderSummary({}); renderTodayList([]); var ll=$('#limitLabel'); if(ll) ll.textContent='3'; return; }
    google.script.run.withSuccessHandler(function(ret){
      renderSummary((ret && ret.summary)||{});
      ALL_LIST=(ret && ret.list ? ret.list.slice() : []).sort(function(a,b){ return String(b.datetime||'').localeCompare(String(a.datetime||'')); });
      var ll=$('#limitLabel'); if(ll) ll.textContent = SHOW_ALL ? ALL_LIST.length : 3;
      renderTodayList(SHOW_ALL ? ALL_LIST : ALL_LIST.slice(0,3));
    }).getTodaySummaryAndListSecure(uid, pass);
  }

  // === ç¯€æµ + éš¨æ©Ÿå»¶é² ===
  var _lastRefreshAt = 0;
  function safeRefresh(force){
    var now = Date.now();
    if (!force && now - _lastRefreshAt < 8000) return; // 8s å…§åªè·‘ä¸€æ¬¡
    _lastRefreshAt = now; refreshSummaryAndList();
  }

  var elBtnMore = $('#btnMore');
  if (elBtnMore) elBtnMore.addEventListener('click', function(){
    SHOW_ALL = !SHOW_ALL;
    var ll=$('#limitLabel'); if(ll) ll.textContent = SHOW_ALL ? ALL_LIST.length : 3;
    renderTodayList(SHOW_ALL ? ALL_LIST : ALL_LIST.slice(0,3));
  });

  // ç°¡å–®ä½ç½®å¿«å–ï¼ˆ30 ç§’å…§ & ç²¾åº¦é”æ¨™å°±ç›´æ¥æ²¿ç”¨ï¼‰
window.__lastGeoCache = window.__lastGeoCache || null;

function getFreshPosition(desiredAcc=60, timeoutMs=15000){
  return new Promise((resolve, reject)=>{
    // 1) å…ˆæª¢æŸ¥å¿«å–
    try{
      if (window.__lastGeoCache){
        var ageMs = Date.now() - (window.__lastGeoCache.ts||0);
        var acc   = window.__lastGeoCache.acc||Infinity;
        if (ageMs < 30000 && acc <= desiredAcc){
          return resolve(window.__lastGeoCache.pos);
        }
      }
    }catch(_){}

    if (!navigator.geolocation) {
      reject(new Error('æ­¤è£ç½®ä¸æ”¯æ´å®šä½'));
      return;
    }

    var done  = false;
    var wid   = null;
    var timer = null;

    function finish(pos, err){
      if (done) return;
      done = true;
      try{ if(wid!==null) navigator.geolocation.clearWatch(wid); }catch(_){}
      if (timer) clearTimeout(timer);

      if (pos && pos.coords){
        // å­˜å…¥å¿«å–
        try{
          window.__lastGeoCache = {
            ts:  Date.now(),
            acc: Math.round(pos.coords.accuracy||9999),
            pos
          };
        }catch(_){}
        resolve(pos);
      }else{
        reject(err || new Error('å®šä½å¤±æ•—'));
      }
    }

    // 2) watchPositionï¼šé€šå¸¸è¼ƒå¿«æ‹¿åˆ°ï¼Œé”åˆ°ç²¾åº¦å°±çµæŸ
    try{
      wid = navigator.geolocation.watchPosition(
        (pos)=>{
          var acc   = (pos.coords && pos.coords.accuracy) || Infinity;
          var fresh = Date.now() - (pos.timestamp || Date.now()) < 60000;
          if (fresh && acc <= desiredAcc) finish(pos);
        },
        (_err)=>{ /* å¿½ç•¥ï¼Œç­‰ fallback */ },
        { enableHighAccuracy:true, maximumAge:0, timeout:timeoutMs }
      );
    }catch(_){}

    // 3) è¶…é timeout é‚„æ²’é”æ¨™ â†’ getCurrentPosition ç•¶ä¿åº•
    timer = setTimeout(()=>{
      navigator.geolocation.getCurrentPosition(
        (pos)=>finish(pos),
        (err)=>finish(null, err),
        { enableHighAccuracy:true, maximumAge:15000, timeout:8000 }
      );
    }, timeoutMs);
  });
}

  // ===== éé˜»æ“‹ç‰ˆæª¢æŸ¥ï¼ˆä¿ç•™ï¼Œä½†ä¸€å¾‹æ”¾è¡Œï¼‰ =====
  function ensureGeoReadyOrExplain(){ return true; }

  /* ===== æ‰“å¡æµç¨‹ï¼šå¼·åŒ–ç‚ºä¸€å®šæœƒè§£å‡ ===== */
async function punchNow(type){
  if (__punching) return;                  // é˜²é€£é»
  const uid  = document.querySelector('#uid')?.value.trim();
  const pass = document.querySelector('#pass')?.value.trim();
  if(!uid || !pass){ alert('è«‹å…ˆè¼¸å…¥ UID èˆ‡ PASSCODE'); return; }

  __punching = true;
  setFreeze(true, 'æ­£åœ¨å–å¾—å®šä½â€¦');

  try{
    // å–å¾—å³æ™‚å®šä½ï¼ˆä½ åŸæœ¬çš„å‡½å¼ï¼‰
    const pos = await getFreshPosition(60, 15000);

    setFreeze(true, 'æ­£åœ¨é€å‡ºæ‰“å¡â€¦');
    const { latitude, longitude, accuracy } = pos.coords || {};
    const payload = {
      uid, passcode: pass, type,
      lat: Number(latitude).toFixed(6),
      lng: Number(longitude).toFixed(6),
      note: '', userAgent: navigator.userAgent,
      geo_at_iso: new Date().toISOString(),
      accuracy: Math.round(accuracy||0)
    };

    await new Promise((resolve, reject)=>{
      google.script.run
        .withSuccessHandler(ret=>{
          if(!ret || !ret.ok){
            reject(new Error('æ‰“å¡å¤±æ•—ï¼š' + (ret && ret.message || 'æœªçŸ¥éŒ¯èª¤')));
            return;
          }
          const resp = document.getElementById('resp');
          if (resp){
            const off = String(ret.verdict||'') === 'offsite';
            resp.innerHTML = `<span class="badge" style="background:${off?'#FEF3C7':'#dcfce7'};color:${off?'#92400E':'#166534'}">
              å·²${type==='in'?'ä¸Šç­':'ä¸‹ç­'} Â· ${off?'ç«™å¤–âš ':'æ­£å¸¸'}
            </span>`;
          }
          try{ refreshSummaryAndList(); }catch(_){}
          resolve();
        })
        .withFailureHandler(err=>{
          reject(new Error('æ‰“å¡å¤±æ•—ï¼ˆä¼ºæœå™¨ï¼‰ï¼š' + (err && err.message || err)));
        })
        .saveEvent(payload);
    });

  }catch(err){
    let msg = (err && err.message) ? String(err.message) : 'ç„¡æ³•å–å¾—å³æ™‚å®šä½ã€‚';
    if (err && err.code===1) msg = 'ç„¡æ³•å–å¾—å³æ™‚å®šä½ï¼ˆè«‹å…è¨±æ­¤ç¶²ç«™çš„å®šä½æ¬Šé™ï¼‰';
    else if (err && err.code===3) msg = 'å®šä½é€¾æ™‚ï¼Œè«‹ç§»è‡³ç©ºæ› è™•é‡è©¦';
    alert(msg);
  }finally{
    // â˜… ç„¡è«–æˆåŠŸæˆ–å¤±æ•—éƒ½æœƒåŸ·è¡Œé€™è£¡ï¼Œç¢ºä¿é é¢è§£å‡ + å¯å†æ¬¡æ“ä½œ
    __punching = false;
    setFreeze(false);
  }
}


  // ===== ç¶å®š =====
  var el;
  el = $('#btn-in');      if (el) el.addEventListener('click', function(){ if(!ensureGeoReadyOrExplain()) return; punchNow('in'); });
  el = $('#btn-out');     if (el) el.addEventListener('click', function(){ if(!ensureGeoReadyOrExplain()) return; punchNow('out'); });
  //el = $('#btn-refresh'); if (el) el.addEventListener('click', function(){ safeRefresh(true); });
// â˜… æŠŠé€™è£¡æ›æˆä½ é‚£æœ¬æœˆæ›† Web App çš„ã€Œéƒ¨ç½²ç¶²å€ï¼ˆexecï¼‰ã€ï¼š
const CAL_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbxv1lT26gb2g5TiiRVLmR3NknzlNN3Ro-IEjpGZSjPMgi4tSUEdyBPO8cdl7h69XabR/exec';

document.getElementById('btn-open-calendar')?.addEventListener('click', function(){
  // é è¨­æœƒè¼‰æœ¬æœˆï¼Œå¦‚è¦æ‰‹å‹•æŒ‡å®šå¹´æœˆä¹Ÿå¯å¸¶ queryï¼š?year=2025&month=9ï¼ˆè¦‹ä¸‹æ–¹å‚™è¨»ï¼‰
  window.open(CAL_WEBAPP_URL, '_blank', 'noopener');
});
  // Modal
  function openModal(title, htmlNode){ $('#req-title').textContent = title; var body=$('#req-body'); body.innerHTML=''; body.appendChild(htmlNode); $('#req-modal').style.display=''; }
  function closeModal(){ $('#req-modal').style.display='none'; }
  el = $('#req-close'); if (el) el.addEventListener('click', closeModal);
  el = $('#req-mask');  if (el) el.addEventListener('click', closeModal);

  // Trip
  el = $('#btn-open-trip');
  if (el) el.addEventListener('click', function(){
    var tpl = document.getElementById('tpl-trip');
    var root = tpl.content.firstElementChild.cloneNode(true);
    var q = function(sel){ return root.querySelector(sel); };

    q('#trip-uid').value  = ($('#uid') && $('#uid').value)  || '';
    q('#trip-pass').value = ($('#pass') && $('#pass').value) || '';

    var submitBtn = q('#btn-trip-submit'), submitting = false;
    submitBtn.addEventListener('click', function(){
      if(submitting) return;
      var p = { uid:q('#trip-uid').value.trim(), passcode:q('#trip-pass').value.trim(),
                date:q('#trip-date').value, location:q('#trip-location').value, note:q('#trip-note').value };
      if (!p.uid || !p.passcode || !p.date || !p.location){ alert('è«‹å¡«å¯«ï¼šUIDã€PASSCODEã€æ—¥æœŸã€åœ°é»/èªªæ˜'); return; }
      submitting = true; submitBtn.disabled = true; submitBtn.textContent = 'é€å‡ºä¸­â€¦';
      google.script.run
        .withSuccessHandler(function(ret){
          submitting = false; submitBtn.disabled = false; submitBtn.textContent = 'é€å‡ºå‡ºå·®ç”³è«‹';
          if(!ret || !ret.ok){ alert('å‡ºå·®ç”³è«‹å¤±æ•—ï¼š' + (ret && ret.message || 'æœªçŸ¥éŒ¯èª¤')); return; }
          alert('å‡ºå·®ç”³è«‹å·²é€å‡º'); closeModal();
        })
        .withFailureHandler(function(err){
          submitting = false; submitBtn.disabled = false; submitBtn.textContent = 'é€å‡ºå‡ºå·®ç”³è«‹';
          alert('å‡ºå·®ç”³è«‹å¤±æ•—ï¼ˆä¼ºæœå™¨ï¼‰ï¼š' + (err && err.message || err));
        })
        .requestTripSimple(p);
    });
    openModal('å‡ºå·®ç”³è«‹', root);
  });

  // Correction
  el = $('#btn-open-corr');
  if (el) el.addEventListener('click', function(){
    var tpl = document.getElementById('tpl-corr');
    var root = tpl.content.firstElementChild.cloneNode(true);
    var q = function(sel){ return root.querySelector(sel); };

    q('#corr-uid').value  = ($('#uid') && $('#uid').value)  || '';
    q('#corr-pass').value = ($('#pass') && $('#pass').value) || '';

    var submitBtn = q('#btn-corr-submit'), submitting = false;
    submitBtn.addEventListener('click', function(){
      if(submitting) return;
      var p = { uid:q('#corr-uid').value.trim(), passcode:q('#corr-pass').value.trim(), date:q('#corr-date').value,
                time:q('#corr-time').value, type:q('#corr-type').value, note:q('#corr-note').value };
      if (!p.uid || !p.passcode || !p.date || !p.time){ alert('è«‹å¡«å¯«ï¼šUIDã€PASSCODEã€æ—¥æœŸã€æ™‚é–“'); return; }
      submitting = true; submitBtn.disabled = true; submitBtn.textContent = 'é€å‡ºä¸­â€¦';
      google.script.run
        .withSuccessHandler(function(ret){
          submitting = false; submitBtn.disabled = false; submitBtn.textContent = 'é€å‡ºè£œå¡ç”³è«‹';
          if(!ret || !ret.ok){ alert('è£œå¡ç”³è«‹å¤±æ•—ï¼š' + (ret && ret.message || 'æœªçŸ¥éŒ¯èª¤')); return; }
          alert('è£œå¡ç”³è«‹å·²é€å‡º'); closeModal();
        })
        .withFailureHandler(function(err){
          submitting = false; submitBtn.disabled = false; submitBtn.textContent = 'é€å‡ºè£œå¡ç”³è«‹';
          alert('è£œå¡ç”³è«‹å¤±æ•—ï¼ˆä¼ºæœå™¨ï¼‰ï¼š' + (err && err.message || err));
        })
        .requestCorrectionSimple(p);
    });
    openModal('è£œå¡ç”³è«‹', root);
  });

  // Leave
  el = $('#btn-leave');
  if (el) el.addEventListener('click', function(){
    var tpl = document.getElementById('tpl-leave');
    var root = tpl.content.firstElementChild.cloneNode(true);
    var q = function(sel){ return root.querySelector(sel); };

    q('#lv-uid').value  = ($('#uid') && $('#uid').value)  || '';
    q('#lv-pass').value = ($('#pass') && $('#pass').value) || '';
    var isFull = function(){ return q('#lv-fullday').checked; };

    var submitBtn = q('#btn-leave-submit'), submitting = false;
    submitBtn.addEventListener('click', function(){
      if(submitting) return;
      var p = {
        uid:q('#lv-uid').value.trim(), passcode:q('#lv-pass').value.trim(), type:q('#lv-type').value,
        start_date:q('#lv-start').value, end_date:q('#lv-end').value || q('#lv-start').value,
        start_time:'', end_time:'', part:isFull()? 'FULL':'', mode:isFull()? 'full':'hours',
        hours:isFull()? '' : q('#lv-hours').value, note:q('#lv-note').value
      };
      if (!p.uid || !p.passcode || !p.type || !p.start_date){ alert('è«‹å¡«å¯«ï¼šUIDã€PASSCODEã€è«‹å‡é¡åˆ¥ã€é–‹å§‹æ—¥æœŸ'); return; }
      if (p.mode==='hours' && !String(p.hours||'').trim()){ alert('è«‹å¡«å¯«æ™‚æ•¸ï¼ˆæˆ–å‹¾æ•´å¤©ï¼‰'); return; }

      submitting = true; submitBtn.disabled = true; submitBtn.textContent = 'é€å‡ºä¸­â€¦';
      google.script.run
        .withSuccessHandler(function(ret){
          submitting = false; submitBtn.disabled = false; submitBtn.textContent = 'é€å‡ºç”³è«‹';
          if(!ret || !ret.ok){ alert('è«‹å‡ç”³è«‹å¤±æ•—ï¼š' + (ret && ret.message || 'æœªçŸ¥éŒ¯èª¤')); return; }
          alert('è«‹å‡ç”³è«‹å·²é€å‡º'); closeModal();
        })
        .withFailureHandler(function(err){
          submitting = false; submitBtn.disabled = false; submitBtn.textContent = 'é€å‡ºç”³è«‹';
          alert('è«‹å‡ç”³è«‹å¤±æ•—ï¼ˆä¼ºæœå™¨ï¼‰ï¼š' + (err && err.message || err));
        })
        .saveLeave(p);
    });
    openModal('è«‹å‡ç”³è«‹', root);
  });

  // Help
  el = $('#btn-help'); if (el) el.addEventListener('click', function(){ var tpl=document.getElementById('tpl-help'); openModal('ä½¿ç”¨èªªæ˜', tpl.content.cloneNode(true)); });

  // åˆè¼‰ï¼šéš¨æ©Ÿå»¶é² + ç¯€æµåˆ·æ–°
  window.addEventListener('load', function(){ setTimeout(function(){ safeRefresh(false); }, 300 + Math.random()*3000); });
})();
// å›ºå®šç‰ˆæœ¬è™Ÿï¼ˆæ‰‹å‹•æ›´æ–°ç”¨ï¼‰
const APP_VERSION = "2025-09-28";  // â† é€™è£¡æ›æˆä½ æœ€æ–°æ›´æ–°çš„æ—¥æœŸ

document.addEventListener("DOMContentLoaded", ()=>{
  const el = document.getElementById("appVersion");
  if(el) el.textContent = `ç‰ˆæœ¬${APP_VERSION}`;
});

</script>
</body>
</html>

    <!-- ä½ åŸæœ¬çš„ CSS å¯ä»¥å…ˆç•™åœ¨ inline <style>ï¼›ä¹‹å¾Œå†æ…¢æ…¢æ¬åˆ° styles.css -->
  </main>

  <script>
    // â· é€™è£¡è²¼ä¸Šä½ åœ¨ç¬¬ 1 éƒ¨æ‹¿åˆ°çš„ GAS ç¶²å€ï¼ˆ/exec çµå°¾ï¼‰
    window.BACKEND_URL = "https://script.google.com/macros/s/AKfycbyzPOkGDKakS3OFqbYL49qOQpv8DRt-O3T6oOJx-mnqnL-Z47xdiqZDUsoALA3E_nC9/exec";

    // â¸ é¡¯ç¤ºåœ¨æ¨™é¡Œæ—é‚Šçš„ç‰ˆæœ¬å­—ä¸²ï¼ˆä½ æ”¹ä¸€æ¬¡å°±å¥½ï¼‰
    window.APP_VERSION = "2025-09-29";
  </script>

  <script src="/app.js"></script>
  <script>
    // â¹ è¨»å†Š Service Workerï¼ˆPWAï¼‰
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js');
      });
    }
  </script>
</body>
</html>
